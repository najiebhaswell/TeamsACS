<!DOCTYPE html>
<html>

<head>
    {{template "header"}}
    <style>
        .badge-ont {
            background: #2196F3;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-router {
            background: #4CAF50;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-gw {
            background: #FF9800;
            color: #fff;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <script>
        let getColumns = function () {
            return [
                {
                    height: 30,
                    cols: [
                        { view: "text", name: "name", label: tr("cpe", "Name"), css: "nborder-input", },
                    ]
                },
                {
                    height: 30,
                    cols: [
                        {
                            view: "combo", name: "node_id", label: tr("cpe", "Node"),
                            options: "/admin/node/options",
                            css: "nborder-input",
                        },
                        { view: "text", name: "sn", label: tr("cpe", "SN"), css: "nborder-input", },
                    ]
                },
                {
                    height: 30,
                    cols: [
                        { view: "text", name: "model", label: tr("cpe", "Model"), css: "nborder-input", },
                        { view: "text", name: "software_version", label: tr("cpe", "Version"), css: "nborder-input", },
                    ]
                },
                {
                    height: 30,
                    cols: [
                        {
                            view: "combo", name: "device_type", label: tr("cpe", "Device Type"),
                            options: [{ id: "router", value: "Router" }, { id: "ont", value: "ONT" }, { id: "gateway", value: "Gateway" }],
                            css: "nborder-input", value: "router",
                        },
                    ]
                },
                {
                    height: 30,
                    cols: [
                        { view: "text", name: "task_tags", label: tr("cpe", "Task Tags"), css: "nborder-input", },
                        {
                            view: "combo", name: "factoryreset_id", label: tr("cpe", "Factoryreset settings"),
                            options: "/admin/cwmp/factoryreset/options", labelWidth: 140,
                            css: "nborder-input",
                        }
                    ]
                },
                { view: "textarea", name: "remark", labelPosition: "top", label: tr("cpe", "Remark") },
            ]
        }


        let openDetail = function (item) {
            let winid = "cpe.detail." + item.id
            let cwmptaskid = webix.uid().toString()
            let cpeparamsId = webix.uid().toString()
            let cpefilterId = webix.uid().toString()
            let cwmpsesstabId = webix.uid().toString()
            wxui.openWindow({
                width: 720,
                height: 576,
                fullscreen: true,
                winid: winid,
                title: tr("cpe", "CPE Detail"),
                body: {
                    rows: [
                        {
                            view: "tabbar",
                            css: "main-tabs",
                            animate: false,
                            bottomOffset: 0,
                            optionWidth: 180,
                            height: 36,
                            align: 'left',
                            multiview: true,
                            value: "cpe_detail_tab", // the initially selected tab
                            options: [
                                { "id": "cpe_detail_tab", "value": tr("cpe", "Information") },
                                { "id": "cpe_rundata_tab", "value": tr("cpe", "TR069 Params") },
                                { "id": "cpe_cwmpsession_tab", "value": tr("cpe", "Cwmp Config session") },
                                { "id": "cpe_cwmptask_tab", "value": tr("cpe", "Cwmp Preset Task") },
                            ]
                        },
                        {
                            cells: [
                                {
                                    id: 'cpe_detail_tab',
                                    rows: [
                                        {
                                            view: "form",
                                            paddingX: 20,
                                            scroll: "auto",
                                            elementsConfig: {
                                                marginY: 0,
                                                labelWidth: 120,
                                            },
                                            css: "detail-form",
                                            url: '/admin/cpe/get?id=' + item.id,
                                            elements: [
                                                {
                                                    height: 30,
                                                    cols: [
                                                        { view: "text", name: "name", label: tr("cpe", "Name"), readonly: true, css: "nborder-input", },
                                                        {
                                                            view: "text",
                                                            name: "system_name",
                                                            label: tr("cpe", "System Name"),
                                                            readonly: true,
                                                            css: "nborder-input",
                                                        },
                                                    ]
                                                },
                                                {
                                                    height: 30,
                                                    cols: [
                                                        { view: "text", name: "sn", label: tr("cpe", "SN"), readonly: true, css: "nborder-input", },
                                                    ]
                                                },
                                                {
                                                    height: 30,
                                                    cols: [
                                                        { view: "text", name: "model", label: tr("cpe", "Model"), readonly: true, css: "nborder-input", },
                                                        {
                                                            view: "text",
                                                            name: "software_version",
                                                            label: tr("cpe", "Version"),
                                                            readonly: true,
                                                            css: "nborder-input",
                                                        },
                                                    ]
                                                },
                                                {
                                                    height: 30,
                                                    cols: [
                                                        {
                                                            view: "text",
                                                            label: tr("cpe", "Uptime"),
                                                            readonly: true,
                                                            css: "nborder-input",
                                                            value: (function () {
                                                                var s = parseInt(item.uptime) || 0;
                                                                if (s === 0) return "0";
                                                                var d = Math.floor(s / 86400);
                                                                var h = Math.floor((s % 86400) / 3600);
                                                                var m = Math.floor((s % 3600) / 60);
                                                                var parts = [];
                                                                if (d > 0) parts.push(d + "d");
                                                                if (h > 0) parts.push(h + "h");
                                                                if (m > 0) parts.push(m + "m");
                                                                return parts.join(" ") || "0m";
                                                            })(),
                                                        },
                                                        {
                                                            view: "text",
                                                            label: tr("cpe", "CPU Use"),
                                                            readonly: true,
                                                            css: "nborder-input",
                                                            value: (item.cpu_usage || "0") + "%",
                                                        },
                                                    ]
                                                },
                                                {
                                                    height: 30,
                                                    cols: [
                                                        {
                                                            view: "text",
                                                            label: tr("cpe", "Memory"),
                                                            readonly: true,
                                                            css: "nborder-input",
                                                            value: (function () {
                                                                var total = parseInt(item.memory_free) || 0;
                                                                var free = parseInt(item.memory_total) || 0;
                                                                if (total === 0) return "N/A";
                                                                var used = total - free;
                                                                var pct = Math.round((used / total) * 100);
                                                                return "Total: " + total + " KB | Free: " + free + " KB | Used: " + pct + "%";
                                                            })(),
                                                        },
                                                    ]
                                                },
                                                {
                                                    height: 30,
                                                    cols: [
                                                        {
                                                            view: "text",
                                                            name: "cwmp_url",
                                                            label: tr("cpe", "Cwmp connection address"),
                                                            readonly: true,
                                                            css: "nborder-input",
                                                        },
                                                    ]
                                                },
                                                {
                                                    height: 30,
                                                    cols: [
                                                        {
                                                            view: "text",
                                                            name: "cwmp_last_inform",
                                                            label: tr("cpe", "Cwmp last inform"),
                                                            readonly: true,
                                                            css: "nborder-input",
                                                        },
                                                    ]
                                                },
                                                {
                                                    height: 30,
                                                    cols: [
                                                        { view: "text", name: "device_type", label: tr("cpe", "Device Type"), readonly: true, css: "nborder-input", },
                                                        { view: "text", name: "manufacturer", label: tr("cpe", "Manufacturer"), readonly: true, css: "nborder-input", },
                                                    ]
                                                },
                                                {
                                                    height: 30,
                                                    cols: [
                                                        { view: "text", name: "fiber_rx_power", label: tr("cpe", "RX Power (dBm)"), readonly: true, css: "nborder-input", },
                                                        { view: "text", name: "fiber_tx_power", label: tr("cpe", "TX Power (dBm)"), readonly: true, css: "nborder-input", },
                                                    ]
                                                },
                                                {
                                                    height: 30,
                                                    cols: [
                                                        { view: "text", name: "pon_sn_hex", label: tr("cpe", "PON SN"), readonly: true, css: "nborder-input", },
                                                        { view: "text", name: "olt_uplink", label: tr("cpe", "OLT Uplink"), readonly: true, css: "nborder-input", },
                                                    ]
                                                },
                                                {
                                                    height: 36,
                                                    css: "nborder-input",
                                                    borderless: true,
                                                    template: function () {
                                                        return '<div style="padding:4px 8px;">' +
                                                            '<button onclick="rebootDevice(\'' + item.id + '\',\'' + (item.sn || '') + '\')" style="background:#e53935;color:#fff;border:none;padding:4px 16px;border-radius:4px;font-size:12px;cursor:pointer;font-weight:bold;">‚ü≥ Reboot</button>' +
                                                            '</div>';
                                                    },
                                                },
                                                {
                                                    view: "template",
                                                    autoheight: true,
                                                    css: "nborder-input",
                                                    borderless: true,
                                                    template: function () {
                                                        var ssidData = item.wifi_ssid;
                                                        if (!ssidData) return '<div style="padding:4px 8px;color:#888;">WiFi: No data</div>';
                                                        try {
                                                            var ssids = JSON.parse(ssidData);
                                                            if (!ssids || ssids.length === 0) return '<div style="padding:4px 8px;color:#888;">WiFi: No data</div>';
                                                            var html = '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
                                                            html += '<tr style="background:#2a3f5f;color:#fff;"><th style="padding:3px 6px;text-align:left;">SSID</th><th style="padding:3px 6px;text-align:left;">Password</th><th style="padding:3px 6px;text-align:center;">Channel</th><th style="padding:3px 6px;text-align:center;">Status</th><th style="padding:3px 6px;text-align:center;">Action</th></tr>';
                                                            for (var i = 0; i < ssids.length; i++) {
                                                                var s = ssids[i];
                                                                var enabled = (s.enable === "true" || s.enable === true || s.enable === "1" || s.enable === 1);
                                                                var badge = enabled ? '<span style="background:#4CAF50;color:#fff;padding:1px 6px;border-radius:3px;font-size:11px;">ON</span>' : '<span style="background:#999;color:#fff;padding:1px 6px;border-radius:3px;font-size:11px;">OFF</span>';
                                                                var ch = s.channel || '';
                                                                var chDisplay = (ch === '' || ch === '0') ? 'Auto' : ch;
                                                                var editBtn = '<button onclick="editWifiSsid(' + item.id + ',' + s.idx + ',\'' + (s.ssid || '').replace(/'/g, "\\'") + '\',\'' + (s.password || '').replace(/'/g, "\\'") + '\',\'' + (s.channel || '0') + '\',\'' + (s.enable || 'true') + '\')" style="background:#1976D2;color:#fff;border:none;padding:2px 8px;border-radius:3px;font-size:11px;cursor:pointer;">Edit</button>';
                                                                var rowBg = (i % 2 === 0) ? '#f8f9fa' : '#fff';
                                                                html += '<tr style="background:' + rowBg + '"><td style="padding:3px 6px;">' + (s.ssid || '-') + '</td><td style="padding:3px 6px;">' + (s.password || '<i style="color:#aaa;">hidden</i>') + '</td><td style="padding:3px 6px;text-align:center;">' + chDisplay + '</td><td style="padding:3px 6px;text-align:center;">' + badge + '</td><td style="padding:3px 6px;text-align:center;">' + editBtn + '</td></tr>';
                                                            }
                                                            html += '</table>';
                                                            return html;
                                                        } catch (e) {
                                                            return '<div style="padding:4px 8px;">WiFi: ' + ssidData + '</div>';
                                                        }
                                                    },
                                                },
                                                {
                                                    view: "template",
                                                    autoheight: true,
                                                    css: "nborder-input",
                                                    borderless: true,
                                                    template: function () {
                                                        var wanData = item.wan_info;
                                                        if (!wanData) return '<div style="padding:4px 8px;color:#888;">WAN: No data</div>';
                                                        try {
                                                            var wans = JSON.parse(wanData);
                                                            if (!wans || wans.length === 0) return '<div style="padding:4px 8px;color:#888;">WAN: No data</div>';
                                                            var html = '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
                                                            html += '<tr style="background:#1a3a5c;color:#fff;"><th style="padding:3px 6px;text-align:left;">Name</th><th style="padding:3px 6px;text-align:left;">Service</th><th style="padding:3px 6px;text-align:left;">Type</th><th style="padding:3px 6px;text-align:left;">IP</th><th style="padding:3px 6px;text-align:left;">Username</th><th style="padding:3px 6px;text-align:left;">Password</th><th style="padding:3px 6px;text-align:center;">VLAN</th><th style="padding:3px 6px;text-align:center;">IP Mode</th><th style="padding:3px 6px;text-align:center;">Status</th><th style="padding:3px 6px;text-align:center;">Action</th></tr>';
                                                            for (var i = 0; i < wans.length; i++) {
                                                                var w = wans[i];
                                                                var svcColor = '#2196F3';
                                                                if (w.service === 'INTERNET') svcColor = '#4CAF50';
                                                                else if (w.service === 'TR069') svcColor = '#FF9800';
                                                                else if (w.service === 'BRIDGE' || w.type === 'Bridge') svcColor = '#9C27B0';
                                                                var svcBadge = w.service ? '<span style="background:' + svcColor + ';color:#fff;padding:1px 6px;border-radius:3px;font-size:11px;">' + w.service + '</span>' : '-';
                                                                var enabled = (w.enable === "true" || w.enable === true || w.enable === "1" || w.enable === 1);
                                                                var statusBadge = enabled ? '<span style="background:#4CAF50;color:#fff;padding:1px 6px;border-radius:3px;font-size:11px;">ON</span>' : '<span style="background:#999;color:#fff;padding:1px 6px;border-radius:3px;font-size:11px;">OFF</span>';
                                                                var vlanDisplay = w.vlan_id || '-';
                                                                var ipMode = w.ip_mode || '-';
                                                                var ipModeColor = '#607D8B';
                                                                if (ipMode === 'Dual Stack') ipModeColor = '#4CAF50';
                                                                else if (ipMode === 'IPv4') ipModeColor = '#2196F3';
                                                                else if (ipMode === 'IPv6') ipModeColor = '#FF9800';
                                                                var ipModeBadge = ipMode !== '-' ? '<span style="background:' + ipModeColor + ';color:#fff;padding:1px 6px;border-radius:3px;font-size:11px;">' + ipMode + '</span>' : '-';
                                                                var ipModeVal = '';
                                                                if (ipMode === 'IPv4') ipModeVal = '1';
                                                                else if (ipMode === 'IPv6') ipModeVal = '2';
                                                                else if (ipMode === 'Dual Stack') ipModeVal = '3';
                                                                var editWanBtn = '<button onclick="editWanConnection(' + item.id + ',\'' + (w.dev_idx || '') + '\',\'' + (w.conn_idx || '') + '\',\'' + (w.type || '') + '\',\'' + (w.name || '').replace(/'/g, "\\'") + '\',\'' + (w.username || '').replace(/'/g, "\\'") + '\',\'' + (w.password || '').replace(/'/g, "\\'") + '\',\'' + (w.enable || 'true') + '\',\'' + ipModeVal + '\',\'' + (w.vlan_id || '') + '\')" style="background:#1976D2;color:#fff;border:none;padding:2px 8px;border-radius:3px;font-size:11px;cursor:pointer;">Edit</button>';
                                                                var rowBg = (i % 2 === 0) ? '#f8f9fa' : '#fff';
                                                                html += '<tr style="background:' + rowBg + '"><td style="padding:3px 6px;">' + (w.name || '-') + '</td><td style="padding:3px 6px;">' + svcBadge + '</td><td style="padding:3px 6px;">' + (w.type || '-') + '</td><td style="padding:3px 6px;">' + (w.ip || '-') + '</td><td style="padding:3px 6px;">' + (w.username || '-') + '</td><td style="padding:3px 6px;">' + (w.password || '-') + '</td><td style="padding:3px 6px;text-align:center;">' + vlanDisplay + '</td><td style="padding:3px 6px;text-align:center;">' + ipModeBadge + '</td><td style="padding:3px 6px;text-align:center;">' + statusBadge + '</td><td style="padding:3px 6px;text-align:center;">' + editWanBtn + '</td></tr>';
                                                            }
                                                            html += '</table>';
                                                            return html;
                                                        } catch (e) {
                                                            return '<div style="padding:4px 8px;">WAN: ' + wanData + '</div>';
                                                        }
                                                    },
                                                },
                                                {
                                                    view: "template",
                                                    autoheight: true,
                                                    css: "nborder-input",
                                                    borderless: true,
                                                    template: function () {
                                                        var clientData = item.lan_clients;
                                                        if (!clientData) return '<div style="padding:4px 8px;color:#888;">Connected Devices: No data</div>';
                                                        try {
                                                            var clients = JSON.parse(clientData);
                                                            if (!clients || clients.length === 0) return '<div style="padding:4px 8px;color:#888;">Connected Devices: No data</div>';
                                                            var html = '<table style="width:100%;border-collapse:collapse;font-size:12px;">';
                                                            html += '<tr style="background:#335577;color:#fff;"><th style="padding:3px 6px;text-align:left;">Hostname</th><th style="padding:3px 6px;text-align:left;">IP Address</th><th style="padding:3px 6px;text-align:left;">MAC Address</th><th style="padding:3px 6px;text-align:center;">Interface</th><th style="padding:3px 6px;text-align:center;">RSSI</th></tr>';
                                                            for (var i = 0; i < clients.length; i++) {
                                                                var c = clients[i];
                                                                var ifType = c.interface || '-';
                                                                var ifBadge = '-';
                                                                if (ifType === '802.11') ifBadge = '<span style="background:#2196F3;color:#fff;padding:1px 6px;border-radius:3px;font-size:11px;">WiFi</span>';
                                                                else if (ifType === 'Ethernet') ifBadge = '<span style="background:#607D8B;color:#fff;padding:1px 6px;border-radius:3px;font-size:11px;">LAN</span>';
                                                                else ifBadge = '<span style="background:#999;color:#fff;padding:1px 6px;border-radius:3px;font-size:11px;">' + ifType + '</span>';
                                                                var rssiVal = c.rssi || '';
                                                                var rssiDisplay = '-';
                                                                if (rssiVal) {
                                                                    var rssiNum = parseInt(rssiVal);
                                                                    var rssiColor = '#4CAF50';
                                                                    if (rssiNum < -80) rssiColor = '#f44336';
                                                                    else if (rssiNum < -70) rssiColor = '#FF9800';
                                                                    else if (rssiNum < -60) rssiColor = '#FFC107';
                                                                    rssiDisplay = '<span style="color:' + rssiColor + ';font-weight:bold;">' + rssiVal + ' dBm</span>';
                                                                }
                                                                var rowBg = (i % 2 === 0) ? '#f8f9fa' : '#fff';
                                                                html += '<tr style="background:' + rowBg + '"><td style="padding:3px 6px;">' + (c.hostname || '-') + '</td><td style="padding:3px 6px;">' + (c.ip || '-') + '</td><td style="padding:3px 6px;">' + (c.mac || '-') + '</td><td style="padding:3px 6px;text-align:center;">' + ifBadge + '</td><td style="padding:3px 6px;text-align:center;">' + rssiDisplay + '</td></tr>';
                                                            }
                                                            html += '</table>';
                                                            return html;
                                                        } catch (e) {
                                                            return '<div style="padding:4px 8px;">Devices: ' + clientData + '</div>';
                                                        }
                                                    },
                                                },
                                                {
                                                    view: "template",
                                                    css: "data-remark",
                                                    template: item.remark,
                                                    borderless: true,
                                                    scroll: "auto"
                                                },
                                            ],
                                        }
                                    ]
                                },
                                {
                                    id: 'cpe_rundata_tab',
                                    rows: [
                                        {
                                            view: "toolbar",
                                            elements: [
                                                {
                                                    view: "combo", id: cpefilterId, width: 320, label: "", labelWidth: 0,
                                                    options: [
                                                        "Device.DeviceInfo.",
                                                        "Device.ManagementServer.",
                                                        "Device.InterfaceStack.",
                                                        "Device.Cellular.",
                                                        "Device.Ethernet.",
                                                        "Device.WiFi.",
                                                        "Device.PPP.",
                                                        "Device.IP.",
                                                        "Device.Routing.",
                                                        "Device.Hosts.",
                                                        "Device.DNS.",
                                                        "Device.DHCPv4.",
                                                        "Device.Firewall.",
                                                        "Device.X_MIKROTIK_Interface.",
                                                        "Device.Optical.",
                                                        "Device.DSL."
                                                    ],
                                                    on: {
                                                        onChange: function (newv, oldv) {
                                                            if (newv) {
                                                                $$(cpeparamsId).filter("#name#", newv);
                                                            } else {
                                                                $$(cpeparamsId).filter();
                                                            }
                                                        }
                                                    }
                                                },
                                                {
                                                    view: "text", on: {
                                                        onTimedKeyPress: function () {
                                                            let prefix = $$(cpefilterId).getValue();
                                                            let value = this.getValue().toLowerCase(); // input data are derived
                                                            $$(cpeparamsId).filter("#name#", prefix + value);
                                                        }
                                                    }
                                                },
                                            ]
                                        },
                                        {
                                            id: cpeparamsId,
                                            view: "unitlist",
                                            uniteBy: function (obj) {
                                                return obj.tag;
                                            },
                                            select: true,
                                            borderless: true,
                                            scroll: "auto",
                                            type: { height: 36 },
                                            template: function (obj) {
                                                let result = [];
                                                if (obj.writable === "1") {
                                                    result.push("<i class='mdi mdi-pencil'></i> ");
                                                } else {
                                                    result.push("<i class='mdi mdi-tag-outline'></i> ");
                                                }
                                                result.push(obj.name);
                                                result.push(" <span style='float: right'> ");
                                                result.push(obj.value);
                                                result.push(" </span> ");
                                                return result.join("");
                                            },
                                            url: "/admin/cpe/params?sn=" + item.sn,
                                        }
                                    ]
                                },
                                {
                                    id: 'cpe_cwmpsession_tab',
                                    rows: [
                                        wxui.getDatatable({
                                            tableid: cwmpsesstabId,
                                            url: '/admin/cwmp/config/session/query',
                                            columns: [
                                                {
                                                    id: "state",
                                                    header: { content: "masterCheckbox", css: "center" },
                                                    headermenu: false,
                                                    adjust: true,
                                                    css: "center",
                                                    template: "{common.checkbox()}"
                                                },
                                                {
                                                    id: "exec_status",
                                                    header: [tr("cwmp", "Status")],
                                                    template: "<a class='do_log_detail' href='javascript:void(0)'><i class='mdi mdi-eye statuscss_#exec_status#' ></i></a> <span class='statuscss_#exec_status#'>#exec_status#</span>",
                                                    adjust: true,
                                                    sort: "server",
                                                },
                                                { id: "device_id", options: "/admin/cpe/options", header: [tr("cwmp", "CPE")], adjust: true },
                                                {
                                                    id: "name",
                                                    header: [tr("cwmp", "Name")],
                                                    adjust: true,
                                                    sort: "server",
                                                },
                                                {
                                                    id: "level",
                                                    header: [tr("cwmp", "Level")],
                                                    adjust: true,
                                                    sort: "server",
                                                },
                                                {
                                                    id: "timeout",
                                                    header: [tr("cwmp", "Timeout")],
                                                    adjust: true,
                                                    sort: "server",
                                                },
                                                {
                                                    id: "exec_time", adjust: true,
                                                    header: [tr("cwmp", "Exec Time")],

                                                    sort: "server",
                                                },
                                                {
                                                    id: "resp_time", adjust: true,
                                                    header: [tr("cwmp", "Resp Time")],
                                                    sort: "server",
                                                },
                                                { id: "none", header: [""], fallspace: true },
                                                // { header: { content: "headerMenu" }, headermenu: false, width: 35 }
                                            ],
                                            leftSplit: 1,
                                            rightSplit: 0,
                                            pager: true,
                                            onClick: {
                                                "do_log_detail": function (e, id, node) {
                                                    let ditem = this.getItem(id)
                                                    wxui.displayTableMessage(node, this.$width - 64, 520, ditem.last_error, "text")
                                                }
                                            }
                                        }),
                                        wxui.getTableFooterBar({
                                            tableid: cwmpsesstabId,
                                            actions: [],
                                            callback: function () {
                                                $$(cwmptaskid).clearAll()
                                                $$(cwmptaskid).load("/admin/cwmp/config/session/query?cpe_id=" + item.id)
                                            }
                                        }),
                                    ]
                                },
                                {
                                    id: 'cpe_cwmptask_tab',
                                    rows: [
                                        wxui.getDatatable({
                                            tableid: cwmptaskid,
                                            url: "/admin/cwmp/presettask/query?sn=" + item.sn,
                                            columns: [
                                                {
                                                    id: "action", header: [tr("cpe", "Message")], adjust: true,
                                                    template: "<a class='prese_ttask_detail statuscss_#status#' href='javascript:void(0)'><i class='mdi mdi-eye' ></i></a>",
                                                },
                                                {
                                                    id: "status", header: [tr("cpe", "Status")], adjust: true, sort: "server",
                                                    template: "<span class=' statuscss_#status#'>#status#</span>",
                                                },
                                                {
                                                    id: "preset_id", header: [tr("cpe", "Name")],
                                                    options: "/admin/cwmp/preset/options", adjust: true, sort: "server"
                                                },
                                                { id: "event", header: [tr("cpe", "Event")], adjust: true, sort: "server" },
                                                { id: "created_at", header: [tr("cpe", "Created")], adjust: true, sort: "server" },
                                                { id: "exec_time", header: [tr("cpe", "Execution time")], adjust: true, sort: "server" },
                                                { id: "resp_time", header: [tr("cpe", "Response time")], adjust: true, sort: "server" },
                                                // {header: {content: "headerMenu"}, headermenu: false, width: 35}
                                            ],
                                            leftSplit: 0,
                                            pager: true,
                                            on: {
                                                onItemDblClick: function (id, e, node) {
                                                    let ditem = this.getItem(id)
                                                    let msg = ditem.request + "\n\n" + ditem.response + "\n\nContent: \n\n" + ditem.content
                                                    wxui.displayTableMessage(node, this.$width - 64, 480, msg, "xml")
                                                }
                                            },
                                            onClick: {
                                                "prese_ttask_detail": function (e, id, node) {
                                                    let ditem = this.getItem(id)
                                                    let msg = ditem.request + "\n\n" + ditem.response + "\n\nContent: \n\n" + ditem.content
                                                    wxui.displayTableMessage(node, this.$width - 64, 520, msg, "xml")
                                                }
                                            }
                                        }),
                                        wxui.getTableFooterBar({
                                            tableid: cwmptaskid,
                                            actions: [],
                                            callback: function () {
                                                $$(cwmptaskid).clearAll()
                                                $$(cwmptaskid).load("/admin/cwmp/presettask/query?sn=" + item.sn)
                                            }
                                        }),
                                    ]
                                },
                            ]
                        }
                    ]
                }

            }).show()
        }

        let deleteItem = function (ids, callback) {
            webix.confirm({
                title: tr("cpe", "Operation confirmation"),
                ok: "Yes", cancel: "No",
                text: "Confirm to delete? This operation is irreversible.",
                callback: function (ev) {
                    if (ev) {
                        webix.ajax().get('/admin/cpe/delete', { ids: ids }).then(function (result) {
                            let resp = result.json();
                            webix.message({ type: resp.msgtype, text: resp.msg, expire: 2000 });
                            if (callback)
                                callback()
                        }).fail(function (xhr) {
                            webix.message({ type: 'error', text: "Delete Failure:" + xhr.statusText, expire: 2000 });
                        });
                    }
                }
            });
        }

        /**
         *  Open management status monitoring
         */
        let openSuperviseListen = function (session, devid) {
            let winid = "supervise.listen." + session
            let respid = webix.uid().toString()
            let evtSource = null
            let listenfunc = function () {
                evtSource = new EventSource('/admin/supervise/action/listen?session=' + session + "&devid=" + devid);
                evtSource.onmessage = function (e) {
                    console.log(e.data)
                    $$(respid).setValue($$(respid).getValue() + e.data + "\n")
                }
                evtSource.onerror = function (e) {
                    console.log("EventSource failed.");
                    evtSource.close()
                };
            }
            wxui.openWindow({
                width: 720,
                height: 576,
                fullscreen: true,
                winid: winid,
                title: "Task monitoring",
                closeEvent: function () {
                    if (evtSource) {
                        console.log("close sse")
                        evtSource.close()
                    }
                },
                body: {
                    padding: 7,
                    rows: [
                        { view: "label", label: tr("cpe", "running status information..."), },
                        { id: respid, name: "script_response", view: "codemirror-editor", mode: "javascript" },
                    ]
                }
            }).show()
            $$(respid).setValue("Listening for status data...\n")
            listenfunc()
        }

        let openSupervise = function (item) {
            let winid = "cpe.supervise." + item.Id
            let getManageTab = function (tabid, ctype, devid) {
                return {
                    id: tabid,
                    paddingX: 5,
                    rows:
                        [
                            {
                                view: "datatable", select: true, rightSplit: 1,
                                columns: [
                                    { id: "name", header: [tr("cpe", "Name")], fillspace: true, sort: "string", },
                                    { id: "type", options: "/admin/supervise/type/options", width: 200, sort: "string", header: ["Type"], },
                                    {
                                        id: "opt", header: '', width: 110, template: function (obj) {
                                            return "<span title='execute' class='table-btn do_execute'><i class='mdi mdi-link'></i> Execute</span> "
                                        }
                                    },
                                ],
                                url: "/admin/supervise/action/query?ctype=" + ctype + "&devid=" + devid,
                                onClick: {
                                    do_execute: function (e, id, node) {
                                        let session = webix.uid()
                                        let ditem = this.getItem(id)
                                        wxui.confirmCall(ditem.level === "major",
                                            "<span style='color: #9D1E15'>There may be unpredictable risks in the current operation, please confirm that you fully understand the current operation</span><br> Are you sure to continue?Ôºü",
                                            function () {
                                                webix.ajax().get('/admin/supervise/action/execute', {
                                                    id: ditem.sid,
                                                    devid: item.id,
                                                    session: session,
                                                    type: ditem.type
                                                }).then(function (result) {
                                                    let resp = result.json();
                                                    webix.message({ type: resp.msgtype, text: resp.msg, expire: 5000 });
                                                });
                                                openSuperviseListen(session)
                                            })
                                    }
                                }
                            }
                        ]
                }
            }

            wxui.openWindow({
                width: 800,
                height: 600,
                fullscreen: true,
                winid: winid,
                title: tr("cpe", "Remote management"),
                body: {
                    rows: [
                        {
                            view: "tabbar",
                            css: "main-tabs",
                            animate: false,
                            bottomOffset: 0,
                            optionWidth: 140,
                            height: 36,
                            align: 'left',
                            multiview: true,
                            value: "device_cwmp_manage_tab", // the initially selected tab
                            options: [
                                { "id": "device_cwmp_manage_tab", "value": tr("cpe", "TR069 Management") },
                                { "id": "device_cwmpconfig_manage_tab", "value": tr("cpe", "TR069 Config") },
                            ]
                        },
                        {
                            cells: [
                                getManageTab("device_cwmp_manage_tab", "cwmp", item.id),
                                getManageTab("device_cwmpconfig_manage_tab", "cwmpconfig", item.id),
                            ]
                        }
                    ]
                },
            }).show()
        }

        let batchUpdateFirmware = function (ids) {
            let winid = "cpe.supervise.batchUpdateFirmware." + webix.uid()
            let formid = webix.uid()
            wxui.openWindow({
                width: 720,
                height: 576,
                fullscreen: true,
                winid: winid,
                title: tr("cpe", "Firmware batch update"),
                body: {
                    rows: [
                        {
                            id: formid,
                            view: "form",
                            scroll: true,
                            elementsConfig: { labelWidth: 140 },
                            elements: [
                                {
                                    rows: [
                                        { label: tr("cpe", "CPE List"), view: "label", },
                                        {
                                            view: "list",
                                            borderless: true,
                                            template: "<i class='mdi mdi-switch'></i> #value#",
                                            url: "/admin/cpe/options?ids=" + ids,
                                        },
                                    ]
                                },
                                {
                                    view: "combo",
                                    name: "firmwareid",
                                    label: tr("cpe", "firmwareConfig"),
                                    options: "/admin/cwmp/firmwareconfig/options",
                                    css: "nborder-input",
                                },
                                {
                                    view: "template", css: "form-desc", height: 100, borderless: true,
                                    template: tr("cpe", "Note that after the firmware is delivered, the device will restart, and the device will automatically upgrade the firmware after restartingÔºå" +
                                        "The device will be disconnected during the upgrade process, and the device will automatically reconnect after the upgrade is complete. Please do not turn off the power during the upgrade process, otherwise the upgrade will fail„ÄÇ" +
                                        "The firmware update operation will be performed asynchronously in the background, please pay attention to monitoring the status of the device")
                                },
                            ],
                        },
                        {
                            padding: 5,
                            cols: [{},
                            {
                                view: "button",
                                css: "webix_primary",
                                value: "Update firmware",
                                width: 150,
                                height: 36,
                                click: function () {
                                    if (!$$(formid).validate()) {
                                        webix.message({
                                            type: "error",
                                            text: tr("global", "Please fill in the valid data."),
                                            expire: 1000
                                        });
                                        return false;
                                    }
                                    webix.confirm({
                                        title: gtr("Operation confirmation"),
                                        ok: "Yes", cancel: "No",
                                        text: "This operation will update the cpe firmware in bulk. Confirm?",
                                        callback: function (ev) {
                                            if (ev) {
                                                let session = webix.uid()
                                                let param = $$(formid).getValues();
                                                param.devids = ids
                                                param.session = session
                                                webix.ajax().post("/admin/superviselog/firmware/update", param).then(function (result) {
                                                    let resp = result.json();
                                                    webix.message({ type: resp.msgtype, text: resp.msg, expire: 5000 });
                                                })
                                                openSuperviseListen(session)
                                            }
                                        }
                                    });
                                }
                            },
                            ]
                        }
                    ]
                },
            }).show()
        }

        let batchExecPreset = function (snlist) {
            let winid = "cpe.supervise.batchExecPreset." + webix.uid()
            let formid = webix.uid().toString()
            wxui.openWindow({
                width: 720,
                height: 576,
                fullscreen: true,
                winid: winid,
                title: tr("cpe", "Execute batch tasks"),
                body: {
                    rows: [
                        {
                            id: formid,
                            view: "form",
                            scroll: true,
                            elementsConfig: { labelWidth: 100 },
                            elements: [
                                {
                                    rows: [
                                        { label: tr("cpe", "CPE List"), view: "label", },
                                        {
                                            view: "list",
                                            borderless: true,
                                            template: "<i class='mdi mdi-switch'></i> #id# - #value#",
                                            url: "/admin/cpe/sn/options?snlist=" + snlist,
                                        },
                                    ]
                                },
                                {
                                    view: "combo",
                                    name: "pid",
                                    label: tr("cpe", "Preset task"),
                                    options: "/admin/cwmp/preset/options",
                                    css: "nborder-input",
                                },
                                {
                                    view: "template", css: "form-desc", height: 100, borderless: true,
                                    template: tr("cpe", "Note: that scheduled tasks may contain actions that cause the device to rebootÔºå<br>" +
                                        "After the execution is complete, the device will automatically reconnect. Do not turn off the power during the execution, otherwise the execution will fail„ÄÇ<br>" +
                                        "The task operation will be performed asynchronously in the background, please pay attention to monitoring the device status")
                                },

                            ],
                        },
                        {
                            padding: 5,
                            cols: [{},
                            {
                                view: "button",
                                css: "webix_primary",
                                label: tr("cpe", "Execute preset"),
                                width: 150,
                                height: 36,
                                click: function () {
                                    if (!$$(formid).validate()) {
                                        webix.message({
                                            type: "error",
                                            text: tr("global", "Please fill in the valid data."),
                                            expire: 1000
                                        });
                                        return false;
                                    }
                                    webix.confirm({
                                        title: gtr("Operation confirmation"),
                                        ok: "Yes", cancel: "No",
                                        text: "This operation will update the cpe firmware in bulk. Confirm?",
                                        callback: function (ev) {
                                            if (ev) {
                                                let session = webix.uid()
                                                let param = $$(formid).getValues();
                                                param.snlist = snlist
                                                webix.ajax().get("/admin/cwmp/preset/execute", param).then(function (result) {
                                                    let resp = result.json();
                                                    webix.message({ type: resp.msgtype, text: resp.msg, expire: 5000 });
                                                })
                                            }
                                        }
                                    });
                                }
                            },
                            ]
                        }
                    ]
                },
            }).show()
        }

        webix.ready(function () {
            let updateipUrl = '/admin/cpe/updateip'
            let importUrl = '/admin/cpe/import'
            let exportUrl = '/admin/cpe/export'
            let tableid = webix.uid().toString();
            let uploadid = webix.uid();
            let ipuploadid = webix.uid();
            let queryid = webix.uid()
            let reloadData = wxui.reloadDataFunc(tableid, "/admin/cpe/query", queryid)
            wxui.initUploadApi(uploadid, importUrl, reloadData);
            wxui.initUploadApi(ipuploadid, updateipUrl, reloadData);
            webix.ui({
                css: "main-panel",
                padding: 7,
                rows: [
                    wxui.getPageToolbar({
                        title: tr("cpe", "CPE device"),
                        icon: "mdi mdi-switch",
                        elements: [
                            wxui.getPrimaryButton(tr("cpe", "Exec tr069 preset"), 150, false, function () {
                                let rows = [];
                                $$(tableid).eachRow(
                                    function (row) {
                                        let item = $$(tableid).getItem(row);
                                        if (item && item.state === 1) {
                                            rows.push(item.sn)
                                        }
                                    }
                                );
                                if (rows.length === 0) {
                                    webix.message({ type: 'error', text: "Please select one", expire: 1500 });
                                } else {
                                    batchExecPreset(rows.join(","));
                                }
                            }),
                            wxui.getPrimaryButton(tr("cpe", "update firmware"), 150, false, function () {
                                let rows = wxui.getTableCheckedIds(tableid);
                                if (rows.length === 0) {
                                    webix.message({ type: 'error', text: "Please select one", expire: 1500 });
                                } else {
                                    batchUpdateFirmware(rows.join(","));
                                }
                            }),
                            wxui.getPrimaryButton(gtr("Edit"), 90, false, function () {
                                let item = $$(tableid).getSelectedItem();
                                if (item) {
                                    let vitem = webix.copy(item)
                                    vitem.api_pwd = ""
                                    wxui.openFormWindow({
                                        width: 640,
                                        height: 640,
                                        fullscreen: true,
                                        title: tr("cpe", "CPE edit"),
                                        data: vitem,
                                        post: "/admin/cpe/update",
                                        callback: reloadData,
                                        elements: getColumns()
                                    }).show();
                                } else {
                                    webix.message({ type: 'error', text: "Please select one", expire: 1500 });
                                }
                            }),
                            wxui.getPrimaryButton(gtr("Clone"), 90, false, function () {
                                let item = $$(tableid).getSelectedItem();
                                if (item) {
                                    let vitem = webix.copy(item)
                                    vitem.id = ""
                                    vitem.api_pwd = ""
                                    wxui.openFormWindow({
                                        width: 640,
                                        height: 640,
                                        fullscreen: true,
                                        title: tr("cpe", "CPE clone"),
                                        data: vitem,
                                        post: "/admin/cpe/add",
                                        callback: reloadData,
                                        elements: getColumns()
                                    }).show();
                                } else {
                                    webix.message({ type: 'error', text: "Please select one", expire: 1500 });
                                }
                            }),
                            wxui.getPrimaryButton(gtr("Create"), 90, false, function () {
                                wxui.openFormWindow({
                                    width: 640,
                                    height: 640,
                                    fullscreen: true,
                                    title: tr("cpe", "CPE create"),
                                    post: "/admin/cpe/add",
                                    callback: reloadData,
                                    elements: getColumns()
                                }).show();
                            }),
                            wxui.getDangerButton(gtr("Remove"), 90, false, function () {
                                let rows = wxui.getTableCheckedIds(tableid);
                                if (rows.length === 0) {
                                    webix.message({ type: 'error', text: "Please select one", expire: 1500 });
                                } else {
                                    deleteItem(rows.join(","), reloadData);
                                }
                            }),
                        ],
                    }),
                    wxui.getTableQueryCustomForm(queryid, [
                        {
                            cols: [
                                {
                                    view: "combo",
                                    name: "equal[node_id]",
                                    options: "/admin/node/options",
                                    label: tr("cpe", "Node"),
                                    labelWidth: 80,
                                    width: 270
                                },
                                {
                                    view: "combo",
                                    name: "equal[device_type]",
                                    options: [{ id: "", value: "All Types" }, { id: "router", value: "Router" }, { id: "ont", value: "ONT" }, { id: "gateway", value: "Gateway" }],
                                    label: tr("cpe", "Type"),
                                    labelWidth: 60,
                                    width: 190
                                },
                                { view: "search", id: "keyword", name: "keyword", placeholder: "Keywords SN/name/description", width: 320 },
                                {
                                    view: "button",
                                    label: gtr("Query"),
                                    css: "webix_transparent",
                                    type: "icon",
                                    icon: "mdi mdi-search-web",
                                    borderless: true,
                                    width: 100,
                                    click: function () {
                                        reloadData()
                                    }
                                }, {}
                            ]
                        }
                    ]),
                    wxui.getDatatable({
                        tableid: tableid,
                        url: '/admin/cpe/query',
                        columns: [
                            {
                                id: "state", header: { content: "masterCheckbox", css: "center" }, headermenu: false, adjust: true,
                                css: "center", template: "{common.checkbox()}", width: 45
                            },
                            {
                                id: "cwmp_status",
                                header: [tr("cpe", "Tr069")],
                                template: "<i class='mdi mdi-link statuscss_#cwmp_status#'></i>",
                                width: 70,
                                sort: "server"
                            },
                            {
                                id: "device_type", header: [tr("cpe", "Type")], width: 80, sort: "server",
                                template: function (obj) {
                                    if (obj.device_type === "ont") return "<span class='badge-ont'>ONT</span>";
                                    if (obj.device_type === "gateway") return "<span class='badge-gw'>GW</span>";
                                    return "<span class='badge-router'>Router</span>";
                                }
                            },
                            {
                                id: "name", header: [tr("cpe", "Name")], adjust: true,
                                sort: "server", template: "<a class='do_detail' href='javascript:void(0)'>#name#</a>"
                            },
                            {
                                id: "node_id", options: "/admin/node/options", adjust: true, sort: "server",
                                header: [tr("cpe", "Node")],
                            },
                            { id: "sn", header: [tr("cpe", "SN")], adjust: true, sort: "server" },
                            { id: "model", header: [tr("cpe", "Model")], adjust: true, sort: "server" },
                            { id: "software_version", header: [tr("cpe", "Version")], adjust: true, sort: "server" },
                            {
                                id: "uptime", header: [tr("cpe", "Uptime")], adjust: true, sort: "server"
                            },
                            { id: "tags", header: [tr("cpe", "Tags")], adjust: true, sort: "server" },
                            { id: "none", header: [""], fillspace: true, sort: "server" },
                            {
                                id: "opt", header: '', template: function (obj) {
                                    let actions = []
                                    actions.push("<span title='management' class='table-btn do_supervise'><i class='mdi mdi-link'></i> " + tr("cpe", "Management") + "</span> ")
                                    return actions.join(" ")
                                }, width: 140
                            },
                            // {header: {content: "headerMenu"}, headermenu: false, width: 35}
                        ],
                        leftSplit: 1,
                        rightSplit: 1,
                        pager: true,
                        on: {
                            onItemDblClick: function (id, e, node) {
                                openDetail(this.getItem(id))
                            }
                        },
                        onClick: {
                            do_detail: function (e, id) {
                                openDetail(this.getItem(id))
                            },
                            do_supervise: function (e, id) {
                                openSupervise(this.getItem(id))
                            }
                        },
                    }),
                    wxui.getTableFooterBar({
                        tableid: tableid,
                        actions: [
                            wxui.getIconButton(gtr("Import"), 90, "import", false, function () {
                                $$(uploadid).fileDialog({});
                            }),
                            wxui.getIconButton(gtr("Export"), 90, "download", false, function () {
                                wxui.exportData(exportUrl, 'cpes.csv')
                            }),
                        ],
                        callback: reloadData
                    }),
                ]
            })
        })
    </script>
    <script>
        function editWifiSsid(devId, ssidIdx, currentSsid, currentPwd, currentCh, currentEnable) {
            if ($$("wifiEditWin")) $$("wifiEditWin").destructor();
            var isEnabled = (currentEnable === "true" || currentEnable === true) ? 1 : 0;
            webix.ui({
                view: "window",
                id: "wifiEditWin",
                head: "Edit WiFi SSID #" + ssidIdx,
                modal: true,
                position: "center",
                width: 400,
                body: {
                    view: "form",
                    id: "wifiEditForm",
                    elements: [
                        { view: "text", name: "ssid", label: "SSID", value: currentSsid, labelWidth: 80 },
                        { view: "text", name: "password", label: "Password", value: currentPwd, labelWidth: 80 },
                        {
                            view: "text", name: "channel", label: "Channel", value: currentCh, labelWidth: 80,
                            bottomLabel: "0 = Auto"
                        },
                        { view: "checkbox", name: "enable", label: "Enable", value: isEnabled, labelWidth: 80 },
                        {
                            cols: [
                                {},
                                {
                                    view: "button", value: "Cancel", width: 80, click: function () {
                                        $$("wifiEditWin").close();
                                    }
                                },
                                {
                                    view: "button", value: "Save", css: "webix_primary", width: 80, click: function () {
                                        var vals = $$("wifiEditForm").getValues();
                                        var fd = new FormData();
                                        fd.append("devid", devId);
                                        fd.append("ssid_idx", ssidIdx);
                                        fd.append("ssid", vals.ssid);
                                        fd.append("password", vals.password);
                                        fd.append("channel", vals.channel);
                                        fd.append("enable", vals.enable ? "true" : "false");
                                        webix.ajax().headers({ "X-CSRF-Token": webix.storage.cookie.get("csrf_token") || "" }).post("/admin/supervise/wifi/set", fd, function (text) {
                                            try {
                                                var r = JSON.parse(text);
                                                if (r.code === 0) {
                                                    webix.message({ type: "success", text: r.msg || "WiFi settings sent" });
                                                } else {
                                                    webix.message({ type: "error", text: r.msg || "Failed" });
                                                }
                                            } catch (e) {
                                                webix.message({ type: "error", text: "Request failed" });
                                            }
                                            $$("wifiEditWin").close();
                                        });
                                    }
                                }
                            ]
                        }
                    ]
                }
            }).show();
        }
    </script>
    <script>
        function editWanConnection(devId, devIdx, connIdx, connType, name, username, password, enable, ipMode, vlanId) {
            if ($$("wanEditWin")) $$("wanEditWin").destructor();
            var isEnabled = (enable === "true" || enable === true) ? 1 : 0;
            var elements = [];
            if (connType === 'PPPoE') {
                elements.push({ view: "text", name: "username", label: "Username", value: username, labelWidth: 90 });
                elements.push({ view: "text", name: "password", label: "Password", value: password, labelWidth: 90 });
            }
            elements.push({ view: "text", name: "vlan_id", label: "VLAN ID", value: vlanId, labelWidth: 90 });
            elements.push({
                view: "select", name: "ip_mode", label: "IP Mode", value: ipMode, labelWidth: 90,
                options: [
                    { id: "", value: "-- No Change --" },
                    { id: "1", value: "IPv4" },
                    { id: "2", value: "IPv6" },
                    { id: "3", value: "Dual Stack" }
                ]
            });
            elements.push({ view: "checkbox", name: "enable", label: "Enable", value: isEnabled, labelWidth: 90 });
            elements.push({
                cols: [
                    {},
                    {
                        view: "button", value: "Cancel", width: 80, click: function () {
                            $$("wanEditWin").close();
                        }
                    },
                    {
                        view: "button", value: "Save", css: "webix_primary", width: 80, click: function () {
                            var vals = $$("wanEditForm").getValues();
                            var fd = new FormData();
                            fd.append("devid", devId);
                            fd.append("dev_idx", devIdx);
                            fd.append("conn_idx", connIdx);
                            fd.append("conn_type", connType);
                            if (connType === 'PPPoE') {
                                fd.append("username", vals.username);
                                fd.append("password", vals.password);
                            }
                            if (vals.vlan_id) fd.append("vlan_id", vals.vlan_id);
                            if (vals.ip_mode) fd.append("ip_mode", vals.ip_mode);
                            fd.append("enable", vals.enable ? "true" : "false");
                            webix.ajax().headers({ "X-CSRF-Token": webix.storage.cookie.get("csrf_token") || "" }).post("/admin/supervise/wan/set", fd, function (text) {
                                try {
                                    var r = JSON.parse(text);
                                    if (r.code === 0) {
                                        webix.message({ type: "success", text: r.msg || "WAN settings sent" });
                                    } else {
                                        webix.message({ type: "error", text: r.msg || "Failed" });
                                    }
                                } catch (e) {
                                    webix.message({ type: "error", text: "Request failed" });
                                }
                                $$("wanEditWin").close();
                            });
                        }
                    }
                ]
            });
            webix.ui({
                view: "window",
                id: "wanEditWin",
                head: "Edit WAN: " + name,
                modal: true,
                position: "center",
                width: 450,
                body: {
                    view: "form",
                    id: "wanEditForm",
                    elements: elements
                }
            }).show();
        }
    </script>
    <script>
        function rebootDevice(devId, sn) {
            webix.confirm({
                title: "Reboot Device",
                text: "Are you sure you want to reboot device " + sn + "?<br>The device will be temporarily offline.",
                ok: "Reboot",
                cancel: "Cancel",
                type: "confirm-error"
            }).then(function () {
                var fd = new FormData();
                fd.append("devid", devId);
                webix.ajax().headers({ "X-CSRF-Token": webix.storage.cookie.get("csrf_token") || "" }).post("/admin/supervise/reboot", fd, function (text) {
                    try {
                        var r = JSON.parse(text);
                        if (r.code === 0) {
                            webix.message({ type: "success", text: r.msg || "Reboot command sent" });
                        } else {
                            webix.message({ type: "error", text: r.msg || "Failed" });
                        }
                    } catch (e) {
                        webix.message({ type: "error", text: "Request failed" });
                    }
                });
            });
        }
    </script>
</body>

</html>